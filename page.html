<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>세종시 노인보호구역 (Kakao 지도)</title>
  <!-- Bootstrap / Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    :root{
      --primary:#1ba5c9; --primary-dark:#0e7fa0; --accent:#f5a623;
      --bg:#f4f6f9; --text:#09233b; --muted:#8aa0ae; --border:#d9e2ec; --white:#ffffff;
    }
    body{ font-family:'Noto Sans',sans-serif; margin:0; padding:0; background:var(--bg); color:var(--text); }
    #map{ height:100vh; margin:0; }

    /* 사이드바 (기존 유지) */
    .side-bar-wrapper{ position:fixed; top:0; left:-250px; width:250px; height:100vh; background:var(--white);
      border-right:1px solid var(--border); box-shadow:0 6px 24px rgba(9,35,59,0.05); overflow-y:auto; transition:left .5s ease;
      z-index:999; padding-top:60px; }
    .side-bar-wrapper ul{ list-style:none; margin:0; padding:20px 10px; }
    .side-bar-wrapper ul>li{ margin-bottom:10px; }
    .side-bar-wrapper ul>li>a{ color:var(--text); text-decoration:none; display:block; padding:12px 14px; border-radius:8px; transition:background-color .2s,color .2s; }
    .side-bar-wrapper ul>li>a:hover{ background:var(--primary); color:var(--white); }

    .toggle-btn{ position:fixed; top:20px; left:20px; background:var(--accent); color:var(--white); border:none;
      border-radius:8px; padding:10px 14px; font-weight:600; cursor:pointer; z-index:1000; box-shadow:0 4px 12px rgba(245,166,35,.25);
      transition:transform .05s ease, background-color .2s ease; }
    .toggle-btn:hover{ background:#ee9f11; } .toggle-btn:active{ transform:translateY(1px); }

    .dropdown-container{ margin:10px 10px 20px 10px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 4px 16px rgba(9,35,59,.06); }
    .form-label{ font-weight:700; color:var(--primary-dark); margin-bottom:6px; }
    .form-select{ border:1px solid var(--border); color:var(--text); padding:8px 32px 8px 12px; border-radius:10px; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .form-select:focus{ border-color:var(--primary); box-shadow:0 0 0 .2rem rgba(27,165,201,.15); outline:none; }

    /* Kakao 지도 위 커스텀 버튼(Leaflet 대체) */
    .map-btn{ position:absolute; right:10px; z-index:900; display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border); border-radius:10px; box-shadow:0 4px 14px rgba(9,35,59,.08); width:40px; height:40px; cursor:pointer; }
    .map-btn i{ font-size:18px; }
    .btn-stack{ position:absolute; top:70px; right:10px; display:flex; flex-direction:column; gap:8px; z-index:900; }
    .btn-back{ position:absolute; top:20px; right:10px; width:80px; height:40px; background:grey; color:#000; }
  </style>
</head>
<body>
  <!-- 사이드바 (기존) -->
  <div id="sideBar" class="side-bar-wrapper">
    <ul>
      <li><a href="javascript:void(0);" onclick="scrollToSection('map')">지도 보기</a></li>
      <li><a href="#">설정</a></li>
      <li><a href="#">도움말</a></li>
      <li>
        <div class="dropdown-container">
          <div class="mb-3">
            <label for="regionSelect" class="form-label">분석</label>
            <select id="regionSelect" class="form-select">
              <option value="default" selected>레이어를 선택하세요</option>
              <option value="DBSCAN">DBSCAN</option>
              <option value="AHP">AHP</option>
            </select>
          </div>
          <div id="clusteringContainer">
            <label id="clusteringLabel" for="layerSelect" class="form-label">Clustering</label>
            <select id="layerSelect" class="form-select">
              <option value="default" selected>레이어를 선택하세요</option>
              <option value="clustering">Clustering</option>
            </select>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <button class="toggle-btn" id="toggleBtn">&#9776; 메뉴</button>

  <!-- Kakao 지도 컨테이너 -->
  <div id="map" aria-label="지도"></div>

  <!-- Kakao Maps JS SDK: 본인 앱키로 교체하세요 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_APP_KEY&libraries=services"></script>
  <script>
    // ====== 공통 유틸 ======
    function scrollToSection(id){ const s=document.getElementById(id); if(s) s.scrollIntoView({behavior:'smooth'}); }

    document.addEventListener('DOMContentLoaded',()=>{
      const sideBar=document.getElementById('sideBar');
      const savedState=localStorage.getItem('sideBarState');
      sideBar.style.left = savedState==='open' ? '0px':'-250px';
    });
    document.getElementById('toggleBtn').addEventListener('click',()=>{
      const sideBar=document.getElementById('sideBar');
      const isOpen=sideBar.style.left==='0px';
      sideBar.style.left=isOpen?'-250px':'0px';
      localStorage.setItem('sideBarState', isOpen?'closed':'open');
    });

    // ====== Kakao 지도 초기화 ======
    const mapContainer=document.getElementById('map');
    const mapOption={ center:new kakao.maps.LatLng(36.50972725,127.2591418), level:7 };// level: 낮을수록 확대
    const map=new kakao.maps.Map(mapContainer,mapOption);

    // 기본 지도타입/확대축소 컨트롤(옵션)
    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    // ====== 데이터 ======
    const clusterData=[
      { lat:36.528835, lon:127.368141, address:"세종특별자치시 부강면 부강리 464-4" },
      { lat:36.464523, lon:127.280050, address:"세종특별자치시 금남면 용포리 124" },
      { lat:36.680030, lon:127.206199, address:"세종특별자치시 전의면 동교리 196-2" },
      { lat:36.562657, lon:127.283087, address:"세종특별자치시 연서면 봉암리 215-7" },
      { lat:36.721783, lon:127.157707, address:"세종특별자치시 소정면 소정리 49-2" }
    ];
    const ahpData=[
      { lat:36.544355, lon:127.274331, address:"세종특별자치시 연기면 아사디길 20" },
      { lat:36.543717, lon:127.246965, address:"세종특별자치시 연기면 외왕길 7" },
      { lat:36.551629, lon:127.282836, address:"세종특별자치시 연기면 잣띠길 58-2" },
      { lat:36.544188, lon:127.275737, address:"세종특별자치시 연기면 당산로 113-5" },
      { lat:36.544291, lon:127.258017, address:"세종특별자치시 연기면 원왕길 8-3" }
    ];

    // ====== 마커/인포윈도우 관리 ======
    const markerImgUrl='https://cdn-icons-png.flaticon.com/128/15598/15598807.png';
    const markerImage=new kakao.maps.MarkerImage(markerImgUrl, new kakao.maps.Size(50,50), {offset:new kakao.maps.Point(16,32)});
    let markers=[]; // 현재 표시 중인 마커 모음
    function clearMarkers(){ markers.forEach(m=>m.setMap(null)); markers=[]; }

    function addPoint(lat,lon,html){
      const pos=new kakao.maps.LatLng(lat,lon);
      const marker=new kakao.maps.Marker({ position:pos, image:markerImage, map });
      const infowindow=new kakao.maps.InfoWindow({ content: `<div style="padding:6px 10px; font-size:13px;">${html}</div>` });
      kakao.maps.event.addListener(marker,'click',()=>{ infowindow.open(map,marker); });
      markers.push(marker);
    }

    // ====== 좌측 드롭다운(Leaflet 로직을 Kakao로 치환) ======
    document.getElementById('regionSelect').addEventListener('change', function(){
      const value=this.value; clearMarkers();
      if(value==='DBSCAN'){
        clusterData.forEach(d=> addPoint(d.lat,d.lon,`<b>주소:</b> ${d.address}`));
        fitToMarkers();
      }else if(value==='AHP'){
        ahpData.forEach(d=> addPoint(d.lat,d.lon,`<b>주소:</b> ${d.address}`));
        fitToMarkers();
      }else if(value==='custom-analysis'){
        window.open('dbscan.html','_blank');
      }else if(value==='default'){
        alert('분석 옵션을 선택하세요.');
      }
    });

    const layerSelect=document.getElementById('layerSelect');
    if(layerSelect){
      layerSelect.addEventListener('change', function(){
        if(this.value==='clustering'){
          window.open('clustering.html','_blank');
          this.value='default';
        }
      });
    }

    function fitToMarkers(){
      if(markers.length===0) return;
      const bounds=new kakao.maps.LatLngBounds();
      markers.forEach(m=> bounds.extend(m.getPosition()));
      map.setBounds(bounds);
    }

    // ====== 내 위치 트래킹(Leaflet 대체) ======
    let geoWatchId=null; let userMarker=null; let accuracyCircle=null;
    function startLocate(){
      if(!('geolocation' in navigator)) { alert('이 브라우저는 위치 정보를 지원하지 않아요.'); return; }
      geoWatchId = navigator.geolocation.watchPosition(
        (pos)=>{
          const { latitude, longitude, accuracy } = pos.coords;
          const latlng=new kakao.maps.LatLng(latitude, longitude);
          if(!userMarker){
            userMarker=new kakao.maps.Marker({ position:latlng, map, title:'내 위치' });
            accuracyCircle=new kakao.maps.Circle({ center:latlng, radius:accuracy, strokeWeight:2, strokeColor:'#4aa3df', strokeOpacity:0.7, strokeStyle:'shortdash', fillColor:'#4aa3df', fillOpacity:0.15 });
            accuracyCircle.setMap(map);
          }else{
            userMarker.setPosition(latlng);
            accuracyCircle.setPosition(latlng);
            accuracyCircle.setRadius(accuracy);
          }
          const currentLevel=map.getLevel();
          if(currentLevel>4){ map.setLevel(4); }
          map.panTo(latlng);
        },
        (err)=>{ alert('위치 권한 거부 또는 오류: '+err.message); stopLocate(); },
        { enableHighAccuracy:true, maximumAge:10000, timeout:20000 }
      );
    }
    function stopLocate(){
      if(geoWatchId!==null){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId=null; }
      if(userMarker){ userMarker.setMap(null); userMarker=null; }
      if(accuracyCircle){ accuracyCircle.setMap(null); accuracyCircle=null; }
    }
    function toggleLocate(){ if(geoWatchId===null) startLocate(); else stopLocate(); }

    // ====== 커스텀 버튼 스택 (Leaflet 커스텀 컨트롤 대체) ======
    const btnBack=document.createElement('button');
    btnBack.className='map-btn btn-back';
    btnBack.innerHTML='<i class="bi bi-arrow-left"></i>';
    btnBack.title='메인으로 돌아가기';
    btnBack.onclick=()=>{ window.location.href='index.html'; };
    mapContainer.appendChild(btnBack);

    const stack=document.createElement('div');
    stack.className='btn-stack';

    const buttonConfigs=[
      { icon:'bi bi-search',     color:'white',       link:'search.html' },
      { icon:'bi bi-eye',        color:'lightpink',   link:'roadview_search.html' },
      { icon:'bi bi-layers',     color:'lightyellow', link:'traffic.html' },
      { icon:'bi bi-geo-alt',    color:'lightgreen',  action:'locate' },
      { icon:'bi bi-map',        color:'skyblue',     link:'traffic.html' },
    ];

    buttonConfigs.forEach(cfg=>{
      const btn=document.createElement('button');
      btn.className='map-btn';
      btn.style.backgroundColor=cfg.color;
      btn.innerHTML=`<i class="${cfg.icon}"></i>`;
      if(cfg.action==='locate'){
        btn.title='내 위치 추적/중지';
        btn.onclick=()=> toggleLocate();
      }else{
        btn.onclick=()=> window.open(cfg.link,'_blank');
      }
      stack.appendChild(btn);
    });
    mapContainer.appendChild(stack);
  </script>
</body>
</html>
