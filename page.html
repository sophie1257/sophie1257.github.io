<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>세종시 노인보호구역</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    /* ===== 기본(이전) 스타일 유지 ===== */
    body { font-family: 'Noto Sans', sans-serif; margin: 0; padding: 0; }
    #map { height: 100vh; margin: 0; }

    .side-bar-wrapper {
      position: fixed; top: 0; left: -250px; width: 250px; height: 100vh;
      background-color: white; overflow-y: auto; transition: left 0.5s ease;
      z-index: 999; padding-top: 60px;
    }
    .side-bar-wrapper ul { list-style-type: none; margin: 0; padding: 20px 10px; }
    .side-bar-wrapper ul > li { margin-bottom: 10px; }
    .side-bar-wrapper ul > li > a {
      color: black; text-decoration: none; display: block; padding: 15px; border-radius: 8px;
    }
    .side-bar-wrapper ul > li > a:hover { background-color: #555; color:#fff; }

    .toggle-btn {
      position: fixed; top: 20px; left: 20px; background-color: rgb(160, 215, 241);
      color: black; border: none; border-radius: 5px; padding: 10px 15px;
      cursor: pointer; z-index: 1000;
    }

    .dropdown-container { margin: 10px 10px 20px 10px; }
    /* 이 클래스는 Leaflet 커스텀 버튼 공통 프레임이므로 유지합니다.
       실제 색/디자인은 아래 ‘대시보드 톤’에서 오버라이드 */
    .leaflet-control-custom {
      display: flex; justify-content: center; align-items: center;
      margin-top: 8px;
    }

    /* ====== (추가) Top-right 버튼만 대시보드 톤 ====== */
    :root{
      --tb-primary-600:#2E5BFF;
      --tb-primary-500:#3C6CFF;
      --tb-primary-100:#EAEFFF;
      --tb-border:#E3E8EF;
      --tb-white:#FFFFFF;
    }

    /* 공통 프레임 보강 */
    .leaflet-control-custom {
      border-radius: 12px;
      transition: transform .08s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease;
      box-shadow: 0 6px 18px rgba(11,31,51,.06);
      border: 1px solid var(--tb-border);
    }
    .leaflet-control-custom i { font-size: 18px; }

    /* 기본 타일 버튼(40x40): 화이트 카드 + 파란 아이콘 */
    .leaflet-control-custom.btn-tile{
      width: 40px; height: 40px;
      background: var(--tb-white);
    }
    .leaflet-control-custom.btn-tile i{
      color: var(--tb-primary-600);
    }
    .leaflet-control-custom.btn-tile:hover{
      background: var(--tb-primary-100);
      border-color: var(--tb-primary-500);
      box-shadow: 0 10px 22px rgba(11,31,51,.10);
      transform: translateY(-1px);
    }

    /* 뒤로가기(80x40): 실색 버튼 + 흰 아이콘 */
    .leaflet-control-custom.btn-back{
      width: 80px; height: 40px;
      background: var(--tb-primary-600);
      border-color: var(--tb-primary-600);
      box-shadow: 0 8px 22px rgba(46,91,255,.28);
      color: var(--tb-white);
    }
    .leaflet-control-custom.btn-back i{
      color: var(--tb-white);
    }
    .leaflet-control-custom.btn-back:hover{
      background: var(--tb-primary-500);
      border-color: var(--tb-primary-500);
      box-shadow: 0 12px 26px rgba(46,91,255,.32);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div id="sideBar" class="side-bar-wrapper">
    <ul>
      <li><a href="javascript:void(0);" onclick="scrollToSection('map')">지도 보기</a></li>
      <li><a href="#">설정</a></li>
      <li><a href="#">도움말</a></li>
      <li>
        <div class="dropdown-container">
          <div class="mb-3">
            <label for="regionSelect" class="form-label">분석</label>
            <select id="regionSelect" class="form-select">
              <option value="default" selected>레이어를 선택하세요</option>
              <option value="DBSCAN">DBSCAN</option>
              <option value="AHP">AHP</option>
              <option value="custom-analysis">DBSCAN분석</option>
            </select>
          </div>

          <div id="clusteringContainer">
            <label id="clusteringLabel" for="layerSelect" class="form-label">Clustering</label>
            <select id="layerSelect" class="form-select">
              <option value="default" selected>레이어를 선택하세요</option>
              <option value="clustering">Clustering</option>
            </select>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <button class="toggle-btn" id="toggleBtn">&#9776; 메뉴</button>
  <div id="map"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // ===== 기존 JS 로직 유지 =====
    const map = L.map('map').setView([36.50972725, 127.2591418], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    document.addEventListener('DOMContentLoaded', () => {
      const sideBar = document.getElementById('sideBar');
      const savedState = localStorage.getItem('sideBarState');
      sideBar.style.left = savedState === 'open' ? '0px' : '-250px';
    });
    document.getElementById('toggleBtn').addEventListener('click', () => {
      const sideBar = document.getElementById('sideBar');
      const isOpen = sideBar.style.left === '0px';
      sideBar.style.left = isOpen ? '-250px' : '0px';
      localStorage.setItem('sideBarState', isOpen ? 'closed' : 'open');
    });

    const markerGroup = L.layerGroup().addTo(map);

    const customIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/128/15598/15598807.png',
      iconSize: [50, 50],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const clusterData = [
      { lat: 36.528835, lon: 127.368141, address: "세종특별자치시 부강면 부강리 464-4" },
      { lat: 36.464523, lon: 127.280050, address: "세종특별자치시 금남면 용포리 124" },
      { lat: 36.680030, lon: 127.206199, address: "세종특별자치시 전의면 동교리 196-2" },
      { lat: 36.562657, lon: 127.283087, address: "세종특별자치시 연서면 봉암리 215-7" },
      { lat: 36.721783, lon: 127.157707, address: "세종특별자치시 소정면 소정리 49-2" }
    ];

    const ahpData = [
      { lat: 36.544355, lon: 127.274331, address: "세종특별자치시 연기면 아사디길 20" },
      { lat: 36.543717, lon: 127.246965, address: "세종특별자치시 연기면 외왕길 7" },
      { lat: 36.551629, lon: 127.282836, address: "세종특별자치시 연기면 잣띠길 58-2" },
      { lat: 36.544188, lon: 127.275737, address: "세종특별자치시 연기면 당산로 113-5" },
      { lat: 36.544291, lon: 127.258017, address: "세종특별자치시 연기면 원왕길 8-3" }
    ];

    // -------- 내 위치 추적 토글 --------
    let geoWatchId = null;
    let userMarker = null;
    let accuracyCircle = null;

    function startLocate() {
      if (!('geolocation' in navigator)) {
        alert('이 브라우저는 위치 정보를 지원하지 않아요.');
        return;
      }
      geoWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const latlng = [latitude, longitude];

          if (!userMarker) {
            userMarker = L.marker(latlng).addTo(map).bindPopup('내 위치');
            accuracyCircle = L.circle(latlng, { radius: accuracy }).addTo(map);
          } else {
            userMarker.setLatLng(latlng);
            accuracyCircle.setLatLng(latlng).setRadius(accuracy);
          }
          if (map.getZoom() < 15) map.setView(latlng, 16, { animate: true });
        },
        (err) => {
          alert('위치 권한이 거부되었거나 오류가 발생했습니다: ' + err.message);
          stopLocate();
        },
        { enableHighAccuracy: true, maximumAge: 10000, timeout: 20000 }
      );
    }

    function stopLocate() {
      if (geoWatchId !== null) {
        navigator.geolocation.clearWatch(geoWatchId);
        geoWatchId = null;
      }
      if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
      if (accuracyCircle) { map.removeLayer(accuracyCircle); accuracyCircle = null; }
    }

    function toggleLocate() { if (geoWatchId === null) startLocate(); else stopLocate(); }

    // 기존 버튼 설정(값은 그대로)
    const buttonConfigs = [
      { icon: 'bi bi-search', color: 'white',       link: 'search.html' },
      { icon: 'bi bi-eye',    color: 'lightpink',   link: 'roadview_search.html' },
      { icon: 'bi bi-layers', color: 'lightyellow', link: 'traffic.html' },
      { icon: 'bi bi-geo-alt',color: 'lightgreen',  action: 'locate' },
      { icon: 'bi bi-map',    color: 'skyblue',     link: 'traffic.html' },
    ];

    // ===== 커스텀 컨트롤: 디자인은 클래스(대시보드 톤)로만 제어 =====
    const CustomButtonControl = L.Control.extend({
      options: { position: 'topright' },
      // variant: 'back' | 'tile'
      initialize: function (icon, color, link, action, customSize = null, variant = 'tile') {
        this.icon = icon; this.color = color; this.link = link; this.action = action;
        this.customSize = customSize; this.variant = variant;
      },
      onAdd: function () {
        const container = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.innerHTML = `<i class="${this.icon}"></i>`;
        container.style.cursor = 'pointer';

        // 버튼 스타일 클래스 적용 (배경색 inline 지정은 하지 않음)
        if (this.variant === 'back') {
          container.classList.add('btn-back');
        } else {
          container.classList.add('btn-tile');
        }

        // 크기 커스텀 전달 시만 적용
        if (this.customSize) {
          container.style.width  = this.customSize.width;
          container.style.height = this.customSize.height;
        }

        // 동작 (기존 로직 유지)
        if (this.action === 'locate') {
          container.title = '내 위치 추적/중지';
          container.onclick = () => toggleLocate();
        } else if (this.action === 'back') {
          container.title = '메인으로 돌아가기';
          container.onclick = () => { window.location.href = 'index.html'; };
        } else {
          container.onclick = () => window.open(this.link, '_blank');
        }
        return container;
      },
    });

    // ✅ 맨 위: 뒤로가기 버튼 (80×40, 실색)
    map.addControl(new CustomButtonControl(
      'bi bi-arrow-left', null, null, 'back',
      { width: '80px', height: '40px' }, 'back'
    ));

    // ✅ 나머지 버튼들: 40×40, 화이트 카드(타일)
    buttonConfigs.forEach(cfg => {
      map.addControl(new CustomButtonControl(
        cfg.icon, cfg.color, cfg.link, cfg.action,
        { width:'40px', height:'40px' }, 'tile'
      ));
    });

    // 분석 셀렉트
    document.getElementById("regionSelect").addEventListener("change", function () {
      const value = this.value;
      markerGroup.clearLayers();

      if (value === "DBSCAN") {
        clusterData.forEach(d => {
          L.marker([d.lat, d.lon], { icon: customIcon }).addTo(markerGroup)
            .bindPopup(`<b>주소:</b> ${d.address}`);
        });
      } else if (value === "AHP") {
        ahpData.forEach(d => {
          L.marker([d.lat, d.lon], { icon: customIcon }).addTo(markerGroup)
            .bindPopup(`<b>주소:</b> ${d.address}`);
        });
      } else if (value === "custom-analysis") {
        window.open('dbscan.html', '_blank');
      } else if (value === "default") {
        alert("분석 옵션을 선택하세요.");
      }
    });

    // 라벨 클릭 시 clustering.html 열기
    document.getElementById("clusteringLabel").addEventListener("click", function () {
      window.open('clustering.html', '_blank');
    });

    // 셀렉트에서 'Clustering' 선택 시에도 열기
    const layerSelect = document.getElementById("layerSelect");
    if (layerSelect) {
      layerSelect.addEventListener("change", function () {
        if (this.value === "clustering") {
          window.open('clustering.html', '_blank');
          this.value = 'default';
        }
      });
    }

    function scrollToSection(id) {
      const section = document.getElementById(id);
      if (section) section.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
